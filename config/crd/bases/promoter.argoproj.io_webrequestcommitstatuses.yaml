---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: webrequestcommitstatuses.promoter.argoproj.io
spec:
  group: promoter.argoproj.io
  names:
    kind: WebRequestCommitStatus
    listKind: WebRequestCommitStatusList
    plural: webrequestcommitstatuses
    singular: webrequestcommitstatus
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.promotionStrategyRef.name
      name: Strategy
      type: string
    - jsonPath: .spec.key
      name: Key
      type: string
    - jsonPath: .status.conditions[?(@.type=="Ready")].status
      name: Ready
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          WebRequestCommitStatus is the Schema for the webrequestcommitstatuses API.

          It makes HTTP requests to external endpoints and evaluates the response using expressions
          to create CommitStatus resources with the validation results.

          The controller polls the configured URL at the specified Polling.Interval.
          When reportOn is "proposed", polling stops after success for a given SHA.
          When reportOn is "active", polling continues forever.

          Workflow:
           1. Controller reads PromotionStrategy to get ProposedHydratedSha and ActiveHydratedSha
           2. Controller renders URL, Headers, and Body templates with SHA context
           3. Controller makes HTTP request with optional authentication
           4. Controller evaluates expression against response
           5. Controller creates/updates CommitStatus with result attached to the SHA specified by reportOn
           6. Controller requeues based on Polling.Interval and success state
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec defines the desired state of WebRequestCommitStatus
            properties:
              description:
                description: |-
                  Description is a human-readable description of this validation that will be shown in the SCM provider
                  (GitHub, GitLab, etc.) as the commit status description.
                  Supports Go templates with environment-specific variables.

                  Available template variables (DescriptionTemplateData):
                    - {{ .Branch }}: the environment branch name (e.g., "environment-staging")
                    - {{ .ProposedHydratedSha }}: proposed commit SHA for this environment
                    - {{ .ActiveHydratedSha }}: active/deployed commit SHA for this environment
                    - {{ .ReportedSha }}: the commit SHA being reported on
                    - {{ .LastSuccessfulSha }}: last SHA that achieved success for this environment
                    - {{ .Phase }}: current phase (success/pending/failure)
                    - {{ .Key }}: the WebRequestCommitStatus key
                    - {{ .Name }}: the WebRequestCommitStatus resource name
                    - {{ .Namespace }}: the WebRequestCommitStatus namespace
                    - {{ .Labels }}: map of labels (use: {{ index .Labels "key" }})
                    - {{ .Annotations }}: map of annotations (use: {{ index .Annotations "key" }})

                  Examples:
                    - "External approval for {{ .Branch }}"
                    - "Checking deployment {{ .ReportedSha | trunc 7 }}"
                    - "{{ .Key }} validation - {{ .Phase }}"

                  If not specified, defaults to empty string.
                type: string
              expression:
                description: |-
                  Expression is evaluated using the expr library (github.com/expr-lang/expr) against the HTTP response.
                  The expression must return a boolean value where true indicates the validation passed.

                  Available variables in the expression context:
                    - Response.StatusCode (int): the HTTP response status code
                    - Response.Body (any): parsed JSON as map[string]any, or raw string if not JSON
                    - Response.Headers (map[string][]string): HTTP response headers

                  Examples:
                    - Response.StatusCode == 200
                    - Response.StatusCode == 200 && Response.Body.approved == true
                    - Response.StatusCode == 200 && Response.Body.status == "approved"
                    - len(Response.Headers["X-Approval"]) > 0
                type: string
              httpRequest:
                description: |-
                  HTTPRequest defines the HTTP request configuration.
                  Supports Go templates in URL, Headers, and Body fields.
                properties:
                  authentication:
                    description: |-
                      Authentication specifies authentication configuration for the HTTP request.

                      Supports multiple authentication methods:
                      - Basic Auth: HTTP Basic Authentication with username/password
                      - Bearer Token: Bearer token authentication (e.g., API keys, JWTs)
                      - OAuth2: OAuth2 client credentials flow for obtaining access tokens
                      - TLS: Mutual TLS (mTLS) with client certificates

                      All credentials must be stored in Kubernetes secrets and referenced via secretRef fields.

                      Examples:
                        # Basic Auth
                        authentication:
                          basic:
                            secretRef:
                              name: my-creds

                        # Bearer Token
                        authentication:
                          bearer:
                            secretRef:
                              name: api-token

                        # OAuth2 Client Credentials
                        authentication:
                          oauth2:
                            tokenURL: "https://auth.example.com/oauth/token"
                            secretRef:
                              name: oauth-creds

                        # TLS Client Certificate
                        authentication:
                          tls:
                            secretRef:
                              name: my-tls-cert
                    properties:
                      basic:
                        description: |-
                          Basic specifies HTTP Basic Authentication.
                          Credentials can be provided inline (with secret references) or via secretRef.
                        properties:
                          secretRef:
                            description: SecretRef references a secret containing
                              username and password.
                            properties:
                              name:
                                description: Name of the secret.
                                type: string
                              passwordKey:
                                description: |-
                                  PasswordKey is the key in the secret containing the password.
                                  Defaults to "password".
                                type: string
                              usernameKey:
                                description: |-
                                  UsernameKey is the key in the secret containing the username.
                                  Defaults to "username".
                                type: string
                            required:
                            - name
                            type: object
                        required:
                        - secretRef
                        type: object
                      bearer:
                        description: |-
                          Bearer specifies Bearer token authentication.
                          Token can be provided inline (with secret reference) or via secretRef.
                        properties:
                          secretRef:
                            description: SecretRef references a secret containing
                              the bearer token.
                            properties:
                              key:
                                description: |-
                                  Key is the key in the secret containing the token.
                                  Defaults to "token".
                                type: string
                              name:
                                description: Name of the secret.
                                type: string
                            required:
                            - name
                            type: object
                        required:
                        - secretRef
                        type: object
                      oauth2:
                        description: |-
                          OAuth2 specifies OAuth2 client credentials authentication.
                          The controller will automatically obtain access tokens from the specified tokenURL.
                        properties:
                          scopes:
                            description: |-
                              Scopes to request from the OAuth2 provider.
                              Optional - some providers don't require scopes for client credentials.
                              Example: ["read:api", "write:api"]
                            items:
                              type: string
                            type: array
                          secretRef:
                            description: SecretRef references a secret containing
                              clientID and clientSecret.
                            properties:
                              clientIDKey:
                                description: |-
                                  ClientIDKey is the key in the secret containing the client ID.
                                  Defaults to "clientID".
                                type: string
                              clientSecretKey:
                                description: |-
                                  ClientSecretKey is the key in the secret containing the client secret.
                                  Defaults to "clientSecret".
                                type: string
                              name:
                                description: Name of the secret.
                                type: string
                            required:
                            - name
                            type: object
                          tokenURL:
                            description: |-
                              TokenURL is the OAuth2 token endpoint where access tokens are obtained.
                              Example: "https://auth.example.com/oauth/token"
                            type: string
                        required:
                        - secretRef
                        - tokenURL
                        type: object
                      tls:
                        description: |-
                          TLS specifies TLS client certificate authentication (mutual TLS).
                          Requires a secret containing the client certificate and private key.
                        properties:
                          secretRef:
                            description: |-
                              SecretRef references a secret containing TLS certificate and key.
                              The secret should be of type kubernetes.io/tls or contain the required keys.
                            properties:
                              caKey:
                                description: |-
                                  CAKey is the key in the secret containing the CA certificate (optional).
                                  Defaults to "ca.crt".
                                type: string
                              certKey:
                                description: |-
                                  CertKey is the key in the secret containing the client certificate.
                                  Defaults to "tls.crt".
                                type: string
                              keyKey:
                                description: |-
                                  KeyKey is the key in the secret containing the private key.
                                  Defaults to "tls.key".
                                type: string
                              name:
                                description: Name of the secret.
                                type: string
                            required:
                            - name
                            type: object
                        required:
                        - secretRef
                        type: object
                    type: object
                  body:
                    description: |-
                      Body is the request body to send.
                      Supports Go templates (see HTTPRequestSpec for available variables).
                    type: string
                  headers:
                    additionalProperties:
                      type: string
                    description: |-
                      Headers are additional HTTP headers to include in the request.
                      Header values support Go templates (see HTTPRequestSpec for available variables).
                    type: object
                  method:
                    description: Method is the HTTP method to use.
                    enum:
                    - GET
                    - POST
                    - PUT
                    - PATCH
                    type: string
                  timeout:
                    default: 30s
                    description: Timeout is the maximum time to wait for the HTTP
                      request to complete.
                    type: string
                  url:
                    description: |-
                      URL is the HTTP endpoint to request.
                      Supports Go templates (see HTTPRequestSpec for available variables).
                    type: string
                required:
                - method
                - url
                type: object
              key:
                description: |-
                  Key is the unique identifier for this validation rule.
                  It is used as the commit status key and in status messages.
                  This key is matched against PromotionStrategy's proposedCommitStatuses or activeCommitStatuses
                  to determine which environments this validation applies to.
                maxLength: 63
                minLength: 1
                pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                type: string
              polling:
                description: Polling controls polling behavior for the HTTP request.
                properties:
                  interval:
                    default: 1m
                    description: |-
                      Interval controls how often to retry the HTTP request while in pending state.
                      When reportOn is "proposed": stops polling after success for a given SHA.
                      When reportOn is "active": always polls at this interval.
                    type: string
                type: object
              promotionStrategyRef:
                description: |-
                  PromotionStrategyRef references the PromotionStrategy this applies to.
                  The controller will check commits from ALL environments in the referenced PromotionStrategy
                  where this WebRequestCommitStatus.Spec.Key matches an entry in either:
                    - PromotionStrategy.Spec.ProposedCommitStatuses (applies to all environments), OR
                    - PromotionStrategy.Spec.ActiveCommitStatuses (applies to all environments), OR
                    - Environment.ProposedCommitStatuses (applies to specific environment), OR
                    - Environment.ActiveCommitStatuses (applies to specific environment)
                properties:
                  name:
                    description: Name is the name of the object to refer to.
                    type: string
                required:
                - name
                type: object
              reportOn:
                default: proposed
                description: |-
                  ReportOn specifies which commit SHA to report the CommitStatus on.
                  - "proposed": Reports on the proposed hydrated commit SHA (default)
                  - "active": Reports on the active hydrated commit SHA

                  When "proposed": Polls until success, then stops polling for that SHA.
                  When "active": Polls forever, even after success (active state can change).
                enum:
                - proposed
                - active
                type: string
            required:
            - expression
            - httpRequest
            - key
            - promotionStrategyRef
            type: object
          status:
            description: status defines the observed state of WebRequestCommitStatus
            properties:
              conditions:
                description: |-
                  Conditions represent the latest available observations of the WebRequestCommitStatus's state.
                  Standard condition types include "Ready" which aggregates the status of all environments.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              environments:
                description: |-
                  Environments holds the validation results for each environment where this validation applies.
                  Each entry corresponds to an environment from the PromotionStrategy where the Key matches
                  either global or environment-specific proposedCommitStatuses/activeCommitStatuses.
                items:
                  description: WebRequestCommitStatusEnvironmentStatus defines the
                    observed status for a specific environment.
                  properties:
                    activeHydratedSha:
                      description: ActiveHydratedSha is the active hydrated commit
                        SHA from the PromotionStrategy.
                      type: string
                    branch:
                      description: Branch is the environment branch name being validated.
                      type: string
                    expressionResult:
                      description: |-
                        ExpressionResult contains the boolean result of the expression evaluation.
                        Only set when the expression successfully evaluates to a boolean.
                      type: boolean
                    lastRequestTime:
                      description: LastRequestTime is when the HTTP request was last
                        made.
                      format: date-time
                      type: string
                    lastSuccessfulSha:
                      description: |-
                        LastSuccessfulSha is the SHA that last achieved success.
                        Used to detect SHA changes - when ReportedSha != LastSuccessfulSha, polling continues.
                        When they match and phase is success, polling stops (for reportOn: proposed).
                      type: string
                    phase:
                      description: |-
                        Phase represents the current validation state of the commit.
                        - "pending": validation has not completed, HTTP request pending, or expression returned false
                        - "success": expression evaluated to true
                        - "failure": expression compilation failed
                      enum:
                      - pending
                      - success
                      - failure
                      type: string
                    proposedHydratedSha:
                      description: ProposedHydratedSha is the proposed hydrated commit
                        SHA from the PromotionStrategy.
                      type: string
                    reportedSha:
                      description: ReportedSha is the SHA where the CommitStatus was
                        reported (based on reportOn field).
                      type: string
                    response:
                      description: Response contains information about the HTTP response
                        from the last request.
                      properties:
                        statusCode:
                          description: StatusCode is the HTTP response status code.
                          type: integer
                      type: object
                  required:
                  - branch
                  - phase
                  - proposedHydratedSha
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - branch
                x-kubernetes-list-type: map
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
