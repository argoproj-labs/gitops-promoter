/*
Copyright 2024.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// Code generated by controller-gen-v0.20. DO NOT EDIT.

package v1alpha1

import (
	v1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// TriggerModeSpecApplyConfiguration represents a declarative configuration of the TriggerModeSpec type for use
// with apply.
//
// TriggerModeSpec defines expression-based trigger configuration.
type TriggerModeSpecApplyConfiguration struct {
	// RequeueDuration specifies how long to wait before requeuing to re-evaluate the trigger expression.
	RequeueDuration *v1.Duration `json:"requeueDuration,omitempty"`
	// Expression is an expr expression that dynamically controls whether polling should continue.
	// When specified, this expression is evaluated AFTER each HTTP request to determine if the controller should
	// requeue and poll again.
	//
	// The expression can return:
	// 1. Boolean: true/false to control polling
	// 2. Object with 'polling' field: {polling: true/false, ...customData}
	// - The 'polling' field controls whether to continue polling
	// - Any additional fields are stored and available in the next reconcile as 'ExpressionData'
	//
	// Available variables in the expression context:
	// - PromotionStrategy (PromotionStrategy): the full PromotionStrategy spec and status
	// - Environment (EnvironmentStatus): current environment's status from PromotionStrategy
	// - Response.StatusCode (int): HTTP response status code from validation request
	// - Response.Body (any): parsed response body (JSON as map[string]any, or raw string)
	// - Response.Headers (map[string][]string): HTTP response headers
	// - ValidationResult (bool): result of the main Expression evaluation
	// - Phase (string): current phase (success/pending/failure)
	// - ReportedSha (string): the SHA being validated
	// - Branch (string): environment branch name
	// - ExpressionData (map[string]any): custom data from previous polling expression evaluation
	//
	// Note: PromotionStrategy.Status.Environments is an ordered array representing the promotion sequence.
	// Environments[0] is the first environment (e.g., dev), Environments[1] is second (e.g., staging), etc.
	// Changes flow through the array in order. To access the previous environment, use array indexing:
	// currentIdx = findIndex(PromotionStrategy.Status.Environments, {.Branch == Branch})
	// previousEnv = currentIdx > 0 ? PromotionStrategy.Status.Environments[currentIdx-1] : nil
	//
	// Examples (Boolean return):
	// # Always poll (equivalent to reportOn: active)
	// - "true"
	//
	// # Stop polling after success (equivalent to reportOn: proposed)
	// - "Phase != 'success'"
	//
	// # Poll until this SHA appears in the healthy history (validates deployment stability)
	// - "!any(Environment.LastHealthyDryShas, {.Sha == ReportedSha})"
	//
	// # Continue polling if PR is not merged yet (monitors promotion progress)
	// - "Phase == 'success' && (Environment.PullRequest == nil || Environment.PullRequest.State != 'merged')"
	//
	// Examples (Object return with state tracking):
	// # Track dry SHA changes and restart polling when it changes
	// - |
	// {
	// polling: len(PromotionStrategy.Status.Environments) > 0 &&
	// PromotionStrategy.Status.Environments[0].Proposed.Dry.Sha != "" &&
	// PromotionStrategy.Status.Environments[0].Proposed.Dry.Sha != ExpressionData["trackedSha"],
	// trackedSha: PromotionStrategy.Status.Environments[0].Proposed.Dry.Sha
	// }
	//
	// # Poll until validation succeeds AND store the success timestamp
	// - |
	// {
	// polling: Phase != 'success',
	// firstSuccessTime: Phase == 'success' && ExpressionData["firstSuccessTime"] == nil ? now() : ExpressionData["firstSuccessTime"]
	// }
	//
	// # Track previous environment SHA and poll until it matches
	// - |
	// let prevEnv = filter(PromotionStrategy.Status.Environments, {.Branch == "environment/staging"})[0];
	// {
	// polling: Phase != 'success' || prevEnv.Active.Hydrated.Sha != ExpressionData["targetSha"],
	// targetSha: ReportedSha
	// }
	Expression *string `json:"expression,omitempty"`
}

// TriggerModeSpecApplyConfiguration constructs a declarative configuration of the TriggerModeSpec type for use with
// apply.
func TriggerModeSpec() *TriggerModeSpecApplyConfiguration {
	return &TriggerModeSpecApplyConfiguration{}
}

// WithRequeueDuration sets the RequeueDuration field in the declarative configuration to the given value
// and returns the receiver, so that objects can be built by chaining "With" function invocations.
// If called multiple times, the RequeueDuration field is set to the value of the last call.
func (b *TriggerModeSpecApplyConfiguration) WithRequeueDuration(value v1.Duration) *TriggerModeSpecApplyConfiguration {
	b.RequeueDuration = &value
	return b
}

// WithExpression sets the Expression field in the declarative configuration to the given value
// and returns the receiver, so that objects can be built by chaining "With" function invocations.
// If called multiple times, the Expression field is set to the value of the last call.
func (b *TriggerModeSpecApplyConfiguration) WithExpression(value string) *TriggerModeSpecApplyConfiguration {
	b.Expression = &value
	return b
}
