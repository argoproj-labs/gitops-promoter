/*
Copyright 2024.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// Code generated by controller-gen-v0.20. DO NOT EDIT.

package v1alpha1

import (
	v1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// TriggerModeSpecApplyConfiguration represents a declarative configuration of the TriggerModeSpec type for use
// with apply.
//
// TriggerModeSpec defines expression-based trigger configuration.
type TriggerModeSpecApplyConfiguration struct {
	// RequeueDuration specifies how long to wait before requeuing to re-evaluate the trigger expression.
	RequeueDuration *v1.Duration `json:"requeueDuration,omitempty"`
	// Expression is an expr expression that dynamically controls whether the HTTP request should be made.
	// When specified, this expression is evaluated BEFORE each HTTP request to determine if the controller should
	// make the request at all.
	//
	// The expression can return:
	// 1. Boolean: true/false to control whether to make the HTTP request
	// 2. Object with 'trigger' field: {trigger: true/false, ...customData}
	// - The 'trigger' field controls whether to make the HTTP request
	// - Any additional fields are stored and available in the next reconcile as 'ExpressionData'
	//
	// Available variables in the expression context:
	// - PromotionStrategy (PromotionStrategy): the full PromotionStrategy spec and status
	// - Environment (EnvironmentStatus): current environment's status from PromotionStrategy
	// - Phase (string): current phase (success/pending/failure)
	// - ReportedSha (string): the SHA being validated
	// - LastSuccessfulSha (string): last SHA that achieved success for this environment
	// - ExpressionData (map[string]any): custom data from previous trigger expression evaluation
	//
	// Note: PromotionStrategy.Status.Environments is an ordered array representing the promotion sequence.
	// Environments[0] is the first environment (e.g., dev), Environments[1] is second (e.g., staging), etc.
	// Changes flow through the array in order. To access the previous environment, use array indexing:
	// currentIdx = findIndex(PromotionStrategy.Status.Environments, {.Branch == Environment.Branch})
	// previousEnv = currentIdx > 0 ? PromotionStrategy.Status.Environments[currentIdx-1] : nil
	//
	// Examples (Boolean return):
	// # Always trigger (equivalent to polling mode)
	// - "true"
	//
	// # Only trigger when SHA changes from what we last tracked
	// - "ReportedSha != ExpressionData['lastCheckedSha']"
	//
	// # Only trigger when previous environment is healthy
	// - "len(filter(PromotionStrategy.Status.Environments, {.Branch == 'environment/staging'})[0].LastHealthyDryShas) > 0"
	//
	// Examples (Object return with state tracking):
	// # Track SHA and only trigger when it changes
	// - |
	// {
	// trigger: ReportedSha != ExpressionData["trackedSha"],
	// trackedSha: ReportedSha
	// }
	Expression *string `json:"expression,omitempty"`
}

// TriggerModeSpecApplyConfiguration constructs a declarative configuration of the TriggerModeSpec type for use with
// apply.
func TriggerModeSpec() *TriggerModeSpecApplyConfiguration {
	return &TriggerModeSpecApplyConfiguration{}
}

// WithRequeueDuration sets the RequeueDuration field in the declarative configuration to the given value
// and returns the receiver, so that objects can be built by chaining "With" function invocations.
// If called multiple times, the RequeueDuration field is set to the value of the last call.
func (b *TriggerModeSpecApplyConfiguration) WithRequeueDuration(value v1.Duration) *TriggerModeSpecApplyConfiguration {
	b.RequeueDuration = &value
	return b
}

// WithExpression sets the Expression field in the declarative configuration to the given value
// and returns the receiver, so that objects can be built by chaining "With" function invocations.
// If called multiple times, the Expression field is set to the value of the last call.
func (b *TriggerModeSpecApplyConfiguration) WithExpression(value string) *TriggerModeSpecApplyConfiguration {
	b.Expression = &value
	return b
}
