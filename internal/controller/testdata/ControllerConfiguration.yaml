# ControllerConfiguration defines the global settings for all promoter controllers.
# Each controller has its own configuration section with WorkQueue settings that control
# how frequently resources are reconciled, how many can run concurrently, and how
# rate limiting is applied to prevent overwhelming external systems.
apiVersion: promoter.argoproj.io/v1alpha1
kind: ControllerConfiguration
metadata:
  name: example-controller-configuration
spec:
  # PromotionStrategy controller manages promotion strategies and creates ChangeTransferPolicies
  promotionStrategy:
    workQueue:
      # How often to automatically requeue resources for reconciliation
      requeueDuration: "5m"
      # Maximum number of concurrent reconcile operations for this controller
      maxConcurrentReconciles: 3
      # Rate limiter controls retry behavior for failed reconciliations
      rateLimiter:
        # Exponential backoff: start at 1s, max out at 1 minute
        exponentialFailure:
          baseDelay: "1s"
          maxDelay: "1m"

  # ChangeTransferPolicy controller handles the actual promotion logic and creates PRs
  changeTransferPolicy:
    workQueue:
      requeueDuration: "5m"
      maxConcurrentReconciles: 5
      rateLimiter:
        # MaxOf combiner: use the maximum delay from multiple rate limiters
        # This combines per-item exponential backoff with a global rate limit
        maxOf:
          - exponentialFailure:
              baseDelay: "1s"
              maxDelay: "2m"
          - bucket:
              # Allow 10 operations per second with bursts up to 20
              qps: 10
              bucket: 20

  # PullRequest controller manages pull request lifecycle
  pullRequest:
    # Template configuration for generating PR titles and descriptions
    template:
      title: "Promote {{ trunc 7 .ChangeTransferPolicy.Status.Proposed.Dry.Sha }} to `{{ .ChangeTransferPolicy.Spec.ActiveBranch }}`"
      description: |
        This PR is promoting the environment branch `{{ .ChangeTransferPolicy.Spec.ActiveBranch }}`.
        
        **Changes:**
        - Current SHA: {{ .ChangeTransferPolicy.Status.Active.Dry.Sha }}
        - Proposed SHA: {{ .ChangeTransferPolicy.Status.Proposed.Dry.Sha }}
    workQueue:
      requeueDuration: "5m"
      maxConcurrentReconciles: 3
      rateLimiter:
        # FastSlow: retry quickly for the first 3 attempts, then slow down
        # Good for handling transient SCM API errors
        fastSlow:
          fastDelay: "500ms"
          slowDelay: "30s"
          maxFastAttempts: 3

  # CommitStatus controller updates commit status based on policies
  commitStatus:
    workQueue:
      requeueDuration: "2m"
      maxConcurrentReconciles: 5
      rateLimiter:
        exponentialFailure:
          baseDelay: "500ms"
          maxDelay: "1m"

  # ArgoCDCommitStatus controller syncs ArgoCD application status to commit statuses
  argocdCommitStatus:
    watchLocalApplications: true
    workQueue:
      requeueDuration: "5m"
      maxConcurrentReconciles: 10
      rateLimiter:
        # Bucket rate limiter: control overall request rate to external APIs
        bucket:
          qps: 20
          bucket: 50
