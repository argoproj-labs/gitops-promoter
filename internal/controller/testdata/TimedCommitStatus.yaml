# TimedCommitStatus provides time-based gating for environment promotions. It monitors how long commits have been
# running in specified environments and creates CommitStatus resources (as active commit statuses) based on configured
# duration requirements. This enables "soak time" or "bake time" policies.
apiVersion: promoter.argoproj.io/v1alpha1
kind: TimedCommitStatus
metadata:
  name: webservice-tier-1
  namespace: default
spec:
  # Reference to the PromotionStrategy this TimedCommitStatus monitors
  promotionStrategyRef:
    name: webservice-tier-1
  # List of environments to monitor for time-based gating.
  # For each environment, the controller will:
  # 1. Check how long the active commit has been running
  # 2. Create a CommitStatus for the CURRENT environment's active SHA
  # 3. Set the CommitStatus phase based on whether duration is met
  environments:
    - branch: environment/development
      duration: 1h
    - branch: environment/staging
      duration: 4h
    - branch: environment/production
      duration: 24h
status:
  # Status is populated by the controller
  conditions:
    - type: Ready
      lastTransitionTime: 2024-01-15T10:00:00Z
      message: All environments satisfied
      reason: ReconciliationSuccess
      status: "True"
      observedGeneration: 1
  environments:
    - branch: environment/development
      sha: abc123def456789012345678901234567890abcd
      commitTime: "2024-01-15T10:00:00Z"
      requiredDuration: 1h
      phase: pending  # pending or success
      atMostDurationRemaining: 14m30s  # Maximum time remaining until the gate is satisfied
    - branch: environment/staging
      sha: def456789012345678901234567890abcdef123456
      commitTime: "2024-01-14T06:00:00Z"
      requiredDuration: 4h
      phase: success
      atMostDurationRemaining: 0s
